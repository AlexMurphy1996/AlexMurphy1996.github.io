<!DOCTYPE html>
<html>
<head>
  <title>Agent CoPilot Widget</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }
    #log {
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 10px;
      box-sizing: border-box;
      width: 100%;
    }
    .response {
      margin: 5px 0;
      padding: 8px;
      border-radius: 5px;
      background: #f4f4f4;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .response button {
      margin-left: 10px;
      padding: 3px 6px;
      font-size: 12px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h3 style="margin: 5px; font-size: 14px;">Watsonx Orchestrate Connector</h3>
  <div id="log"></div>

  <!-- Correct LP Agent SDK -->
  <script src="https://lpcdn.lpsnmedia.net/webagent/client-SDK.min.js"></script>

  <script>
    (async () => {
      if (!window.lpTag || !lpTag.agentSDK) {
        console.error("Agent SDK not available. Make sure this is running inside LivePerson Agent Workspace.");
        return;
      }

      const SDK = lpTag.agentSDK;
      SDK.init();

      const logDiv = document.getElementById("log");
      const log = (msg, isResponse = false) => {
        if (isResponse) {
          const wrapper = document.createElement("div");
          wrapper.className = "response";

          const span = document.createElement("span");
          span.textContent = msg;

          const copyBtn = document.createElement("button");
          copyBtn.textContent = "Send to Customer";
          copyBtn.addEventListener("click", () => {
            SDK.command('Write ChatLine', { text: msg });
          });

          wrapper.appendChild(span);
          wrapper.appendChild(copyBtn);
          logDiv.appendChild(wrapper);
        } else {
          logDiv.textContent += msg + "\n";
        }
        logDiv.scrollTop = logDiv.scrollHeight;
      };

      log("Agent SDK initialized âœ…");

      // --- Proxy configuration ---
      const PROXY_URL = "https://proxyserver-app.1zxfao4b0y0q.eu-gb.codeengine.appdomain.cloud/trigger-agent";

      async function sendToOrchestrate(conversationId, text) {
        try {
          const res = await fetch(PROXY_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: text })
          });

          if (!res.ok) throw new Error("Proxy request failed");

          const data = await res.json();
          log(`Orchestrate: ${data.reply || JSON.stringify(data)}`, true);
        } catch (err) {
          log("Error sending to Orchestrate proxy: " + err.message);
        }
      }

      // --- Listen for new customer messages only ---
      SDK.bind('chatTranscript.newLine', function(data) {
        const line = data.newValue;
        if (line && line.source === 'visitor' && line.text) {
          const conversationId = SDK.chatInfo?.rtSessionId || 'unknown';
          log(`[Customer] ${line.text}`);
          sendToOrchestrate(conversationId, line.text);
        }
      });

      // --- Clean up sessions on conversation close ---
      SDK.bind('conversation.closed', function() {
        const conversationId = SDK.chatInfo?.rtSessionId || 'unknown';
        log(`Conversation ${conversationId} closed. (Tell proxy to clean up if needed)`);
      });
    })();
  </script>
</body>
</html>
